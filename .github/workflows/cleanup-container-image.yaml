name: 'Cleanup Container Images'

on:
  schedule:
    # Run daily at 01:00 JST
    - cron: '0 16 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  packages: write

jobs:
  cleanup-container:
    name: 'Cleanup ${{ matrix.service }}'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ["docs", "monolith", "nyx"]
      fail-fast: false
    steps:
      - name: Cleanup container images
        uses: panicboat/deploy-actions/container-cleaner@main
        with:
          # GitHub Container Registry requires PERSONAL_ACCESS_TOKEN, not Fine-grained personal access tokens
          token: ${{ secrets.GITHUB_TOKEN }}
          image-name: monorepo/${{ matrix.service }}
          pr-retention-days: 14

  summary:
    name: 'Cleanup Summary'
    needs: cleanup-container
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "ðŸ“Š Cleanup Summary"
          echo "Services: monorepo/docs, monorepo/monolith, monorepo/nyx"
          echo "Cleanup job status: ${{ needs.cleanup-container.result }}"
