name: 'GitHub OIDC Auth - CI/CD'

on:
  pull_request:
    branches:
      - staging/github-oidc-auth
      - production/github-oidc-auth
    paths:
      - 'github-oidc-auth/**'
      - '.github/workflows/github-oidc-auth-*.yaml'
      - '.github/workflows/reusable-*.yaml'
      - '.github/scripts/load-terragrunt-config.js'
      - 'terragrunt-action-root.yaml'
  push:
    branches:
      - staging/github-oidc-auth
      - production/github-oidc-auth
    paths:
      - 'github-oidc-auth/**'
      - '.github/workflows/github-oidc-auth-*.yaml'
      - '.github/workflows/reusable-*.yaml'
      - '.github/scripts/load-terragrunt-config.js'
      - 'terragrunt-action-root.yaml'

env:
  SERVICE_NAME: github-oidc-auth
  SERVICE_PATH: github-oidc-auth

jobs:
  terragrunt-plan:
    name: 'Terragrunt Plan'
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-terragrunt-plan.yaml
    with:
      project_name: github-oidc-auth
    permissions:
      contents: read
      pull-requests: write
      id-token: write

  terragrunt-apply:
    name: 'Terragrunt Apply'
    if: github.event_name == 'push'
    uses: ./.github/workflows/reusable-terragrunt-apply.yaml
    with:
      project_name: github-oidc-auth
      auto_approve: true
    permissions:
      contents: read
      id-token: write

  deployment-summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [terragrunt-apply]
    if: always() && github.event_name == 'push'
    steps:
    - name: Create deployment summary
      run: |
        echo "## ðŸš€ GitHub OIDC Auth Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Service**: github-oidc-auth" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Infrastructure**: ${{ needs.terragrunt-apply.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
