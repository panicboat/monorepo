name: 'GitHub OIDC Auth - CI/CD (New Architecture)'

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - '**'
    paths:
      - 'github-oidc-auth/**'
      - '.github/workflows/github-oidc-auth--*.yaml'
      - '.github/workflows/reusable--*.yaml'
      - '.github/workflows/wait-for-workflows.yaml'
  push:
    branches:
      - develop
      - staging/github-oidc-auth
      - production/github-oidc-auth
    paths:
      - 'github-oidc-auth/**'

jobs:
  validate-new-architecture:
    name: 'Validate New Architecture Setup'
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scenario == 'validate_new_architecture'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -O /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq

      - name: Validate mapping configuration
        run: |
          MAPPING_FILE=".github/directory-label-mapping.yaml"

          echo "ğŸ” æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­å®šã®æ¤œè¨¼"
          echo "================================"

          if [ ! -f "$MAPPING_FILE" ]; then
            echo "âŒ ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $MAPPING_FILE"
            exit 1
          fi

          echo "âœ… ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"

          # è¨­å®šã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
          echo ""
          echo "ğŸ“‹ github-oidc-auth ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®š:"
          echo "-----------------------------------"

          # github-oidc-auth ã®è¨­å®šã‚’ç¢ºèª
          GITHUB_OIDC_MAPPINGS=$(yq e '.mappings | to_entries | map(select(.key | startswith("github-oidc-auth"))) | from_entries' "$MAPPING_FILE")
          echo "$GITHUB_OIDC_MAPPINGS" | yq e '. | to_entries | .[] | "ğŸ“ " + .key + " â†’ " + (.value.labels | join(", "))'

          echo ""
          echo "ğŸŒ ç’°å¢ƒè¨­å®š:"
          echo "------------"
          yq e '.environment_config | to_entries | .[] | "ğŸ”§ " + .key + ": " + .value.aws_region + " (" + .value.iam_role_plan + ")"' "$MAPPING_FILE"

          echo ""
          echo "âœ… è¨­å®šæ¤œè¨¼å®Œäº†"

      - name: Test label parsing logic
        run: |
          echo ""
          echo "ğŸ§ª ãƒ©ãƒ™ãƒ«è§£æãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ"
          echo "==============================="

          # ãƒ†ã‚¹ãƒˆç”¨ãƒ©ãƒ™ãƒ«
          TEST_LABELS=(
            "deploy:github-oidc-auth:develop"
            "deploy:github-oidc-auth:staging"
            "deploy:github-oidc-auth:production"
          )

          for label in "${TEST_LABELS[@]}"; do
            echo "Testing label: $label"

            if [[ $label =~ ^deploy:([^:]+):([^:]+)(:([^:]+))?$ ]]; then
              SERVICE="${BASH_REMATCH[1]}"
              ENVIRONMENT="${BASH_REMATCH[2]}"
              STACK="${BASH_REMATCH[4]:-terragrunt}"

              echo "  âœ… Service: $SERVICE, Environment: $ENVIRONMENT, Stack: $STACK"
            else
              echo "  âŒ Invalid label format"
            fi
          done

          echo ""
          echo "âœ… ãƒ©ãƒ™ãƒ«è§£æãƒ†ã‚¹ãƒˆå®Œäº†"

  emergency-deploy:
    name: 'Emergency Deploy (Legacy Compatibility)'
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scenario == 'emergency_deploy'
    steps:
      - name: Emergency deploy notice
        run: |
          echo "ğŸš¨ ç·Šæ€¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰"
          echo "å¯¾è±¡ç’°å¢ƒ: ${{ github.event.inputs.target_environment }}"
          echo ""
          echo "æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ç·Šæ€¥æªç½®ã¨ã—ã¦ã€"
          echo "æ—¢å­˜ã®reusableãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¾ã™ã€‚"

      - name: Call legacy terragrunt orchestrator
        uses: ./.github/workflows/reusable--terragrunt-orchestrator.yaml
        secrets: inherit
        with:
          project-name: github-oidc-auth
          action-type: 'apply'

  architecture-comparison:
    name: 'Compare Old vs New Architecture'
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scenario == 'compare_with_legacy'
    steps:
      - name: Architecture comparison
        run: |
          echo "ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¯”è¼ƒ"
          echo "===================="
          echo ""
          echo "ğŸ”µ å¾“æ¥ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:"
          echo "  - ãƒ•ã‚¡ã‚¤ãƒ«: github-oidc-auth--ci.yaml"
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: path-based (github-oidc-auth/**)"
          echo "  - å‡¦ç†: reusable--terragrunt-orchestrator.yaml"
          echo "  - è¨­å®š: .github/terragrunt-actions-config.yaml"
          echo ""
          echo "ğŸŸ¢ æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:"
          echo "  - ãƒ•ã‚¡ã‚¤ãƒ«1: detect-changes-and-label.yaml"
          echo "  - ãƒ•ã‚¡ã‚¤ãƒ«2: deploy-based-on-labels.yaml"
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: label-based"
          echo "  - è¨­å®š: .github/directory-label-mapping.yaml"
          echo ""
          echo "ğŸ“ˆ åˆ©ç‚¹:"
          echo "  âœ… å·®åˆ†æ¤œçŸ¥ã¨ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œã®åˆ†é›¢"
          echo "  âœ… æ‰‹å‹•ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¶å¾¡ãŒå¯èƒ½"
          echo "  âœ… æ–°ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã®è¨­å®šãŒç°¡å˜"
          echo "  âœ… PRãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹è¦–è¦šçš„ãªç¢ºèª"
          echo ""
          echo "ğŸ”„ ç§»è¡Œæ‰‹é †:"
          echo "  1. æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ†ã‚¹ãƒˆå®Œäº†"
          echo "  2. æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ®µéšçš„ç„¡åŠ¹åŒ–"
          echo "  3. æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æœ¬æ ¼é‹ç”¨é–‹å§‹"
          echo "  4. å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤"
