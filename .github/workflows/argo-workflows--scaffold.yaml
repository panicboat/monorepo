---
name: argo-workflows / scaffold
on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: true
      owner:
        description: 'Owner name'
        required: true
      namespace:
        description: 'Workflow namespace'
        required: true
        type: choice
        options:
          - workflow
          - workflow-secure
      kind:
        description: 'Workflow kind'
        required: true
        type: choice
        options:
          - CronWorkflow
          - WorkflowTemplate
      name:
        description: 'Workflow name'
        required: true
      overlays:
        default: 'develop,production,staging'
        description: 'Environment to be deployed. Please enter comma-separated entries.'
        required: true
      is_create_service_account:
        default: 'false'
        description: |
          この Workflow が AWS API を利用する場合は true を選択した上で別途 Terraform で IRSA を作成し annotations に指定してください。
          AWS API を使わない場合は false のままで OK です。
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
      is_create_brank_patches:
        default: 'true'
        description: |
          作成されるファイルを最低限にしたい場合は false を選択してください。
          空のパッチファイルを作成しても良い場合は true のままで OK です。
        required: false
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  scaffold:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Generate token
        id: token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SANDBOX_APP_ID }}
          private-key: ${{ secrets.SANDBOX_PRIVATE_KEY }}

      - uses: ./.github/actions/scaffold-argo-workflows
        id: scaffold
        with:
          service: ${{ github.event.inputs.service }}
          owner: ${{ github.event.inputs.owner }}
          namespace: ${{ github.event.inputs.namespace }}
          kind: ${{ github.event.inputs.kind }}
          name: ${{ github.event.inputs.name }}
          overlays: ${{ github.event.inputs.overlays }}
          is_create_service_account: ${{ github.event.inputs.is_create_service_account }}
          is_create_brank_patches: ${{ github.event.inputs.is_create_brank_patches }}

      - uses: int128/update-generated-files-action@v2
        with:
          token: ${{ steps.token.outputs.token }}
          title: 'chore(${{ github.event.inputs.service }}): generate manifests by scaffold-argo-workflows'
          body: |
            This PR was generated by scaffold-argo-workflows.
            Please review the changes and merge it if it looks good.
            ## Checklist
            The manifests created using Scaffold are minimal.
            Please check the following items and consider additional support.
            ### WorkflowTemplate
            - [ ] Add `spec.serviceAccountName` if you need permissions for AWS resources, etc.
            - [ ] Add `spec.templates[].retryStrategy` if you need to retry the workflow.
            ### CronWorkflow
            - [ ] Add `spec.workflowSpec.serviceAccountName` if you need permissions for AWS resources, etc.
            - [ ] Add `spec.workflowSpec.templates[].retryStrategy` if you need to retry the workflow.
          labels: |
            scaffold-argo-workflows
          commit-message: 'chore(${{ github.event.inputs.service }}): generate manifests by scaffold-argo-workflows'
