name: 'Auto Label - Detect Changes and Apply Labels (Pure GHA v4)'

# PRä½œæˆãƒ»æ›´æ–°æ™‚ã«å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œçŸ¥ã—ã€
# ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«åŸºã¥ã„ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã™ã‚‹
# Pure GitHub Actions implementation (v4)

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - '**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-and-label:
    name: 'Detect changes and update PR labels'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Detect file changes with path filters
        id: changes
        uses: dorny/paths-filter@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          filters: |
            terragrunt:
              - '**/terragrunt/**'
            kubernetes:
              - '**/kubernetes/**'

      - name: Manage PR labels with GitHub Script
        id: manage-labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Service and environment mapping based on path filters
            const serviceEnvironmentMap = {
              'github-oidc-auth-develop': {
                service: 'github-oidc-auth',
                environment: 'develop',
                color: '28a745'
              },
              'github-oidc-auth-production': {
                service: 'github-oidc-auth',
                environment: 'production',
                color: 'dc3545'
              },
              'github-oidc-auth-staging': {
                service: 'github-oidc-auth',
                environment: 'staging',
                color: 'ffc107'
              },
              'github-actions-claude-code-action-monorepo': {
                service: 'github-actions-claude-code-action',
                environment: 'monorepo',
                color: '17a2b8'
              },
              'github-repository-generated-manifests': {
                service: 'github-repository',
                environment: 'generated-manifests',
                color: '6f42c1'
              },
              'github-repository-kubernetes-clusters': {
                service: 'github-repository',
                environment: 'kubernetes-clusters',
                color: '20c997'
              },
              'github-repository-monorepo': {
                service: 'github-repository',
                environment: 'monorepo',
                color: '17a2b8'
              }
            };

            // Get change detection results
            const changes = {
              'github-oidc-auth-develop': '${{ steps.changes.outputs.github-oidc-auth-develop }}' === 'true',
              'github-oidc-auth-production': '${{ steps.changes.outputs.github-oidc-auth-production }}' === 'true',
              'github-oidc-auth-staging': '${{ steps.changes.outputs.github-oidc-auth-staging }}' === 'true',
              'github-actions-claude-code-action-monorepo': '${{ steps.changes.outputs.github-actions-claude-code-action-monorepo }}' === 'true',
              'github-repository-generated-manifests': '${{ steps.changes.outputs.github-repository-generated-manifests }}' === 'true',
              'github-repository-kubernetes-clusters': '${{ steps.changes.outputs.github-repository-kubernetes-clusters }}' === 'true',
              'github-repository-monorepo': '${{ steps.changes.outputs.github-repository-monorepo }}' === 'true'
            };

            console.log('Change detection results:', changes);

            // Generate required labels based on detected changes
            const requiredLabels = [];
            for (const [key, hasChanges] of Object.entries(changes)) {
              if (hasChanges && serviceEnvironmentMap[key]) {
                const { service, environment } = serviceEnvironmentMap[key];
                const label = `deploy:${service}:${environment}`;
                requiredLabels.push(label);
              }
            }

            console.log('Required labels:', requiredLabels);

            // Get current PR labels (only deploy: labels)
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const currentDeployLabels = currentLabels
              .map(label => label.name)
              .filter(name => name.startsWith('deploy:'));

            console.log('Current deploy labels:', currentDeployLabels);

            // Create labels if they don't exist
            for (const labelName of requiredLabels) {
              const key = Object.keys(serviceEnvironmentMap).find(k => {
                const { service, environment } = serviceEnvironmentMap[k];
                return `deploy:${service}:${environment}` === labelName;
              });

              const color = key ? serviceEnvironmentMap[key].color : '0052cc';

              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName
                });
                console.log(`Label ${labelName} already exists`);
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Creating label: ${labelName} with color: #${color}`);
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: labelName,
                      color: color,
                      description: 'Auto-generated deployment label'
                    });
                  } catch (createError) {
                    console.error(`Failed to create label ${labelName}:`, createError.message);
                  }
                }
              }
            }

            // Remove old deploy labels that are no longer needed
            const labelsToRemove = currentDeployLabels.filter(label => !requiredLabels.includes(label));
            for (const label of labelsToRemove) {
              console.log(`Removing label: ${label}`);
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (error) {
                console.error(`Failed to remove label ${label}:`, error.message);
              }
            }

            // Add new required labels
            const labelsToAdd = requiredLabels.filter(label => !currentDeployLabels.includes(label));
            for (const label of labelsToAdd) {
              console.log(`Adding label: ${label}`);
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [label]
                });
              } catch (error) {
                console.error(`Failed to add label ${label}:`, error.message);
              }
            }

            // Store results for comment step
            core.setOutput('required_labels', JSON.stringify(requiredLabels));
            core.setOutput('labels_added', JSON.stringify(labelsToAdd));
            core.setOutput('labels_removed', JSON.stringify(labelsToRemove));
            core.setOutput('has_changes', requiredLabels.length > 0 ? 'true' : 'false');

            return {
              requiredLabels,
              labelsAdded,
              labelsRemoved,
              hasChanges: requiredLabels.length > 0
            };

      - name: Comment on PR with deployment info
        if: steps.manage-labels.outputs.has_changes == 'true'
        uses: thollander/actions-comment-pull-request@v2
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          comment_tag: auto-label-deployment-info
          mode: upsert
          message: |
            ## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®æ¤œçŸ¥

            ã“ã®PRã®å¤‰æ›´ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã¨ã—ã¦æ¤œçŸ¥ã•ã‚Œã¾ã—ãŸï¼š

            **æ¤œçŸ¥ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«:**
            ${{ steps.manage-labels.outputs.required_labels != '[]' && steps.manage-labels.outputs.required_labels != '' && 'ä»¥ä¸‹ã®ãƒ©ãƒ™ãƒ«ãŒè‡ªå‹•ã§ä»˜ä¸ã•ã‚Œã¾ã—ãŸï¼š' || 'ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã¨ãªã‚‹å¤‰æ›´ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚' }}

            ${{ steps.manage-labels.outputs.required_labels != '[]' && steps.manage-labels.outputs.required_labels != '' && steps.manage-labels.outputs.required_labels || '' }}

            **å¤‰æ›´æ¤œçŸ¥ã®è©³ç´°:**
            - ğŸ” **Terragrunt å…¨èˆ¬**: `${{ steps.changes.outputs.terragrunt }}`
            - ğŸ”‘ **GitHub OIDC Auth (develop)**: `${{ steps.changes.outputs.github-oidc-auth-develop }}`
            - ğŸ”‘ **GitHub OIDC Auth (production)**: `${{ steps.changes.outputs.github-oidc-auth-production }}`
            - ğŸ”‘ **GitHub OIDC Auth (staging)**: `${{ steps.changes.outputs.github-oidc-auth-staging }}`
            - âš¡ **Claude Code Action (monorepo)**: `${{ steps.changes.outputs.github-actions-claude-code-action-monorepo }}`
            - ğŸ“¦ **GitHub Repository (generated-manifests)**: `${{ steps.changes.outputs.github-repository-generated-manifests }}`
            - ğŸ“¦ **GitHub Repository (kubernetes-clusters)**: `${{ steps.changes.outputs.github-repository-kubernetes-clusters }}`
            - ğŸ“¦ **GitHub Repository (monorepo)**: `${{ steps.changes.outputs.github-repository-monorepo }}`

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€å¯¾è±¡ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
            - ãƒ©ãƒ™ãƒ«ã‚’æ‰‹å‹•ã§å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ç‰¹å®šã®ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™
            - ãƒ©ãƒ™ãƒ«ã‚’æ‰‹å‹•ã§è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€è¿½åŠ ã®ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã«å«ã‚ã‚‰ã‚Œã¾ã™

            ### ãƒ©ãƒ™ãƒ«ç®¡ç†ã®å¤‰æ›´
            ${{ steps.manage-labels.outputs.labels_added != '[]' && steps.manage-labels.outputs.labels_added != '' && format('**è¿½åŠ ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«:** {0}', steps.manage-labels.outputs.labels_added) || '' }}
            ${{ steps.manage-labels.outputs.labels_removed != '[]' && steps.manage-labels.outputs.labels_removed != '' && format('**å‰Šé™¤ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«:** {0}', steps.manage-labels.outputs.labels_removed) || '' }}

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Auto Label Pure GHA v4 ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°ã•ã‚Œã¾ã—ãŸ*

      - name: Add comment when no changes detected
        if: steps.manage-labels.outputs.has_changes == 'false'
        uses: thollander/actions-comment-pull-request@v2
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          comment_tag: auto-label-deployment-info
          mode: upsert
          message: |
            ## â„¹ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®æ¤œçŸ¥çµæœ

            ã“ã®PRã®å¤‰æ›´ã§ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

            **å¤‰æ›´æ¤œçŸ¥ã®è©³ç´°:**
            - ğŸ” **Terragrunt å…¨èˆ¬**: `${{ steps.changes.outputs.terragrunt }}`
            - ğŸ”‘ **GitHub OIDC Auth (develop)**: `${{ steps.changes.outputs.github-oidc-auth-develop }}`
            - ğŸ”‘ **GitHub OIDC Auth (production)**: `${{ steps.changes.outputs.github-oidc-auth-production }}`
            - ğŸ”‘ **GitHub OIDC Auth (staging)**: `${{ steps.changes.outputs.github-oidc-auth-staging }}`
            - âš¡ **Claude Code Action (monorepo)**: `${{ steps.changes.outputs.github-actions-claude-code-action-monorepo }}`
            - ğŸ“¦ **GitHub Repository (generated-manifests)**: `${{ steps.changes.outputs.github-repository-generated-manifests }}`
            - ğŸ“¦ **GitHub Repository (kubernetes-clusters)**: `${{ steps.changes.outputs.github-repository-kubernetes-clusters }}`
            - ğŸ“¦ **GitHub Repository (monorepo)**: `${{ steps.changes.outputs.github-repository-monorepo }}`

            æ‰‹å‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ç‰¹å®šã®ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Auto Label Pure GHA v4 ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°ã•ã‚Œã¾ã—ãŸ*

      - name: Summary
        run: |
          REQUIRED_LABELS='${{ steps.manage-labels.outputs.required_labels }}'
          HAS_CHANGES='${{ steps.manage-labels.outputs.has_changes }}'

          if [ "$HAS_CHANGES" = "false" ]; then
            echo "âœ… å¤‰æ›´æ¤œçŸ¥å®Œäº†: ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãªã—"
            echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªã‚‚ã®ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
          else
            echo "âœ… å¤‰æ›´æ¤œçŸ¥å®Œäº†: ãƒ©ãƒ™ãƒ«ä»˜ä¸æ¸ˆã¿"
            echo "æ¤œçŸ¥ã•ã‚ŒãŸãƒ©ãƒ™ãƒ«: $REQUIRED_LABELS"
          fi

          echo "Pure GHA v4 ã«ã‚ˆã‚‹è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ä¸ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
