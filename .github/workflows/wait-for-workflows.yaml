name: Wait for Workflows
on:
  pull_request:
    branches-ignore:
      - main

jobs:
  wait-for-workflows:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      pull-requests: write
      actions: read
      checks: read
    steps:

    - name: Get GitHub App Token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ vars.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}
        permission-actions: read
        permission-checks: read
        permission-pull-requests: write

    - name: Check if other workflows exist
      id: check-other-workflows
      run: |
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"

        gh api repos/${{ github.repository }}/actions/runs \
          --jq --arg sha "$HEAD_SHA" \
          '.workflow_runs[] | select(.head_sha == $sha and .name != "Wait for Workflows" and (.status == "in_progress" or .status == "queued"))' \
          > running_workflows.json

        RUNNING_COUNT=$(jq -s 'length' running_workflows.json)
        echo "Running workflows: $RUNNING_COUNT"

        if [[ $RUNNING_COUNT -eq 0 ]]; then
          echo "No other workflows running, skipping wait"
          echo "should-wait=false" >> $GITHUB_OUTPUT
        else
          echo "Found running workflows, will wait"
          jq -r '.name' running_workflows.json
          echo "should-wait=true" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Wait for workflows with timeout
      if: steps.check-other-workflows.outputs.should-wait == 'true'
      timeout-minutes: 5
      run: |
        echo "Waiting for other workflows to complete..."
        ATTEMPTS=0
        MAX_ATTEMPTS=10

        while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          gh api repos/${{ github.repository }}/actions/runs \
            --jq --arg sha "$HEAD_SHA" \
            '.workflow_runs[] | select(.head_sha == $sha and .name != "Wait for Workflows" and (.status == "in_progress" or .status == "queued"))' \
            > current_running.json

          RUNNING_COUNT=$(jq -s 'length' current_running.json)
          echo "Attempt $((ATTEMPTS + 1)): $RUNNING_COUNT workflows still running"

          if [[ $RUNNING_COUNT -eq 0 ]]; then
            echo "All workflows completed!"
            break
          fi

          sleep 30
          ATTEMPTS=$((ATTEMPTS + 1))
        done

        if [[ $ATTEMPTS -eq $MAX_ATTEMPTS ]]; then
          echo "Timeout reached, proceeding anyway"
        fi
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Get all workflow statuses
      id: workflow-status
      run: |
        echo "Getting workflow status for PR #${{ github.event.pull_request.number }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"

        gh api repos/${{ github.repository }}/actions/runs \
          --jq --arg sha "$HEAD_SHA" \
          '.workflow_runs[] | select(.head_sha == $sha and .name != "Wait for Workflows") | {name: .name, conclusion: .conclusion, status: .status, html_url: .html_url}' \
          > workflow_results.json

        echo "Workflow results:"
        cat workflow_results.json

        SUCCESS_COUNT=$(jq 'select(.conclusion == "success")' workflow_results.json | jq -s 'length')
        FAILURE_COUNT=$(jq 'select(.conclusion == "failure")' workflow_results.json | jq -s 'length')
        IN_PROGRESS_COUNT=$(jq 'select(.status == "in_progress")' workflow_results.json | jq -s 'length')
        TOTAL_COUNT=$(jq -s 'length' workflow_results.json)

        echo "success-count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "failure-count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
        echo "in-progress-count=$IN_PROGRESS_COUNT" >> $GITHUB_OUTPUT
        echo "total-count=$TOTAL_COUNT" >> $GITHUB_OUTPUT

        if [[ $IN_PROGRESS_COUNT -gt 0 ]]; then
          echo "overall-status=in_progress" >> $GITHUB_OUTPUT
        elif [[ $FAILURE_COUNT -gt 0 ]]; then
          echo "overall-status=failure" >> $GITHUB_OUTPUT
        elif [[ $SUCCESS_COUNT -eq $TOTAL_COUNT ]] && [[ $TOTAL_COUNT -gt 0 ]]; then
          echo "overall-status=success" >> $GITHUB_OUTPUT
        else
          echo "overall-status=unknown" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Generate comment content
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        OVERALL_STATUS="${{ steps.workflow-status.outputs.overall-status }}"
        SUCCESS_COUNT="${{ steps.workflow-status.outputs.success-count }}"
        FAILURE_COUNT="${{ steps.workflow-status.outputs.failure-count }}"
        IN_PROGRESS_COUNT="${{ steps.workflow-status.outputs.in-progress-count }}"
        TOTAL_COUNT="${{ steps.workflow-status.outputs.total-count }}"

        {
          echo "<!-- WORKFLOW_STATUS_COMMENT -->"
          echo "## ğŸ”„ Workflow Status Report"
          echo ""
          echo "**Last updated:** $TIMESTAMP"
          echo "**Commit:** \`${{ github.event.pull_request.head.sha }}\`"
          echo ""

          case "$OVERALL_STATUS" in
            "success")
              echo "### âœ… All Workflows Passed!"
              echo ""
              echo "ğŸ‰ **Status:** All $TOTAL_COUNT workflows completed successfully"
              ;;
            "failure")
              echo "### âŒ Some Workflows Failed"
              echo ""
              echo "ğŸ“Š **Summary:**"
              echo "- âœ… Success: $SUCCESS_COUNT"
              echo "- âŒ Failed: $FAILURE_COUNT"
              echo "- ğŸ“‹ Total: $TOTAL_COUNT"
              ;;
            "in_progress")
              echo "### â³ Workflows Still Running"
              echo ""
              echo "ğŸ“Š **Summary:**"
              echo "- âœ… Success: $SUCCESS_COUNT"
              echo "- âŒ Failed: $FAILURE_COUNT"
              echo "- â³ In Progress: $IN_PROGRESS_COUNT"
              echo "- ğŸ“‹ Total: $TOTAL_COUNT"
              ;;
            *)
              echo "### â“ No Workflows Found"
              echo ""
              echo "No workflows found for this commit."
              ;;
          esac

          echo ""
          echo "### ğŸ“‹ Workflow Details"
          echo ""

          if [[ -s workflow_results.json ]]; then
            echo "| Workflow | Status | Result |"
            echo "|----------|---------|--------|"

            jq -r '. as $item |
              if .conclusion == "success" then "âœ…"
              elif .conclusion == "failure" then "âŒ"
              elif .status == "in_progress" then "â³"
              else "â¸ï¸" end as $icon |
              .conclusion // .status as $result |
              "| [\(.name)](\(.html_url)) | \($icon) | \($result) |"' workflow_results.json
          else
            echo "No workflow data available."
          fi

          echo ""
          echo "---"
          echo "*This comment is automatically updated when workflow status changes.*"

        } > comment_body.md

        echo "Generated comment:"
        cat comment_body.md

    - name: Get GitHub App info
      id: app-info
      run: |
        APP_SLUG=$(gh api user --jq '.login')
        echo "app-slug=$APP_SLUG" >> $GITHUB_OUTPUT
        echo "GitHub App slug: $APP_SLUG"
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

    - name: Find existing comment
      uses: peter-evans/find-comment@v3
      id: find-comment
      with:
        token: ${{ steps.app-token.outputs.token }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: '${{ steps.app-info.outputs.app-slug }}'
        body-includes: '<!-- WORKFLOW_STATUS_COMMENT -->'

    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ steps.app-token.outputs.token }}
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body-path: comment_body.md
        edit-mode: replace

    - name: Notify Slack on failure
      if: steps.workflow-status.outputs.overall-status == 'failure'
      uses: slackapi/slack-github-action@v1.27.0
      with:
        channel-id: 'C1234567890'
        slack-message: |
          ğŸš¨ Some workflows failed in PR #${{ github.event.pull_request.number }}

          ğŸ“Š Summary:
          - âœ… Success: ${{ steps.workflow-status.outputs.success-count }}
          - âŒ Failed: ${{ steps.workflow-status.outputs.failure-count }}
          - ğŸ“‹ Total: ${{ steps.workflow-status.outputs.total-count }}

          ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}
          ğŸ”— PR: ${{ github.event.pull_request.html_url }}
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    - name: Notify Slack on success
      if: steps.workflow-status.outputs.overall-status == 'success'
      uses: slackapi/slack-github-action@v1.27.0
      with:
        channel-id: 'C1234567890'
        slack-message: |
          ğŸ‰ All workflows passed for PR #${{ github.event.pull_request.number }}

          âœ… **Status:** All ${{ steps.workflow-status.outputs.total-count }} workflows completed successfully

          ğŸ“ **Title:** ${{ github.event.pull_request.title }}
          ğŸ‘¤ **Author:** ${{ github.event.pull_request.user.login }}
          ğŸ·ï¸ **Branch:** ${{ github.event.pull_request.head.ref }}
          ğŸ”— **PR:** ${{ github.event.pull_request.html_url }}

          Ready for review and merge! ğŸš€
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    - name: Fail if workflows failed
      if: steps.workflow-status.outputs.overall-status == 'failure'
      run: |
        echo "âŒ Some workflows failed - failing this workflow as well"
        exit 1

    - name: Success actions
      if: steps.workflow-status.outputs.overall-status == 'success'
      run: |
        echo "âœ… All workflows passed successfully!"
        echo "PR #${{ github.event.pull_request.number }} is ready for review and merge."
