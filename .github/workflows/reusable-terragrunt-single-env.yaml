name: 'Reusable Terragrunt Single Environment'

on:
  workflow_call:
    inputs:
      project_name:
        required: true
        type: string
        description: 'Project name for terragrunt execution'
      environment:
        required: true
        type: string
        description: 'Environment name (develop, staging, production, etc.)'
      terraform_version:
        required: false
        type: string
        default: '1.5.7'
        description: 'Terraform version'
      terragrunt_version:
        required: false
        type: string
        default: '0.53.2'
        description: 'Terragrunt version'
      action_type:
        required: true
        type: string
        description: 'Action type: plan or apply'

jobs:
  terragrunt-execution:
    name: '${{ inputs.action_type }} - ${{ inputs.environment }}'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load Terragrunt configuration
        id: load-config
        run: |
          CONFIG_FILE=".github/terragrunt-actions-config.yaml"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Configuration file not found: $CONFIG_FILE"
            exit 1
          fi

          # 環境固有の設定を取得、なければdefaultを使用
          PLAN_IAM_ROLE=$(yq e ".${{ inputs.environment }}.iam_role_plan // .default.iam_role_plan" "$CONFIG_FILE")
          APPLY_IAM_ROLE=$(yq e ".${{ inputs.environment }}.iam_role_apply // .default.iam_role_apply" "$CONFIG_FILE")
          AWS_REGION=$(yq e ".${{ inputs.environment }}.aws_region // .default.aws_region // \"us-east-1\"" "$CONFIG_FILE")
          WORKING_DIR=$(yq e ".${{ inputs.environment }}.working_directory // \"\"" "$CONFIG_FILE")

          # working_directoryが指定されていない場合は自動検出
          if [ -z "$WORKING_DIR" ] || [ "$WORKING_DIR" == "null" ]; then
            # 複数パターンを検索
            POSSIBLE_PATHS=(
              "${{ inputs.project_name }}/terragrunt/envs/${{ inputs.environment }}"
              "*/${{ inputs.project_name }}/terragrunt/envs/${{ inputs.environment }}"
            )

            for path_pattern in "${POSSIBLE_PATHS[@]}"; do
              FOUND_PATH=$(find . -path "./$path_pattern" -type d | head -1)
              if [ -n "$FOUND_PATH" ]; then
                WORKING_DIR="$FOUND_PATH"
                break
              fi
            done
          fi

          if [ -z "$WORKING_DIR" ] || [ "$WORKING_DIR" == "null" ]; then
            echo "Working directory not found for project: ${{ inputs.project_name }}, environment: ${{ inputs.environment }}"
            exit 1
          fi

          echo "plan-iam-role=$PLAN_IAM_ROLE" >> $GITHUB_OUTPUT
          echo "apply-iam-role=$APPLY_IAM_ROLE" >> $GITHUB_OUTPUT
          echo "aws-region=$AWS_REGION" >> $GITHUB_OUTPUT
          echo "working-directory=$WORKING_DIR" >> $GITHUB_OUTPUT

          echo "Configuration loaded:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Plan IAM Role: $PLAN_IAM_ROLE"
          echo "  Apply IAM Role: $APPLY_IAM_ROLE"
          echo "  AWS Region: $AWS_REGION"
          echo "  Working Directory: $WORKING_DIR"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.action_type == 'plan' && steps.load-config.outputs.plan-iam-role || steps.load-config.outputs.apply-iam-role }}
          aws-region: ${{ steps.load-config.outputs.aws-region }}
          role-session-name: GitHubActions-Terragrunt-${{ inputs.action_type }}-${{ inputs.environment }}
          audience: sts.amazonaws.com

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Setup Terragrunt
        run: |
          wget -O terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v${{ inputs.terragrunt_version }}/terragrunt_linux_amd64
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/

      - name: Terragrunt Plan
        if: inputs.action_type == 'plan'
        id: plan
        working-directory: ${{ steps.load-config.outputs.working-directory }}
        run: |
          echo "Running terragrunt init..."
          terragrunt init -no-color

          echo "Running terragrunt plan..."
          terragrunt plan -no-color -detailed-exitcode > plan_output.txt 2>&1
          PLAN_EXIT_CODE=$?

          echo "Plan exit code: $PLAN_EXIT_CODE"
          echo "Plan output:"
          cat plan_output.txt

          # Planの結果を解析
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            PLAN_STATUS="✅ No changes"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            PLAN_STATUS="✅ Changes detected"
          else
            PLAN_STATUS="❌ Failed"
          fi

          # 変更数を抽出
          ADD_COUNT=$(grep -c "will be created" plan_output.txt || echo "0")
          CHANGE_COUNT=$(grep -c "will be updated" plan_output.txt || echo "0")
          DESTROY_COUNT=$(grep -c "will be destroyed" plan_output.txt || echo "0")

          # 出力を制限（30,000文字まで）
          PLAN_OUTPUT=$(cat plan_output.txt)
          if [ ${#PLAN_OUTPUT} -gt 30000 ]; then
            PLAN_OUTPUT="${PLAN_OUTPUT:0:30000}... (output truncated, see workflow logs for full details)"
          fi

          echo "plan-status=$PLAN_STATUS" >> $GITHUB_OUTPUT
          echo "add-count=$ADD_COUNT" >> $GITHUB_OUTPUT
          echo "change-count=$CHANGE_COUNT" >> $GITHUB_OUTPUT
          echo "destroy-count=$DESTROY_COUNT" >> $GITHUB_OUTPUT
          echo "plan-output<<EOF" >> $GITHUB_OUTPUT
          echo "$PLAN_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $PLAN_EXIT_CODE
        continue-on-error: true
        env:
          TF_INPUT: false
          TERRAGRUNT_IAM_ROLE: ${{ steps.load-config.outputs.plan-iam-role }}
          AWS_DEFAULT_REGION: ${{ steps.load-config.outputs.aws-region }}

      - name: Terragrunt Apply
        if: inputs.action_type == 'apply'
        id: apply
        working-directory: ${{ steps.load-config.outputs.working-directory }}
        run: |
          echo "Running terragrunt init..."
          terragrunt init -no-color

          echo "Running terragrunt apply..."
          terragrunt apply -auto-approve -no-color > apply_output.txt 2>&1
          APPLY_EXIT_CODE=$?

          echo "Apply exit code: $APPLY_EXIT_CODE"
          echo "Apply output:"
          cat apply_output.txt

          # Applyの結果を解析
          if [ $APPLY_EXIT_CODE -eq 0 ]; then
            APPLY_STATUS="✅ Success"
          else
            APPLY_STATUS="❌ Failed"
          fi

          # 変更数を抽出
          ADDED_COUNT=$(grep -c "Creation complete" apply_output.txt || echo "0")
          CHANGED_COUNT=$(grep -c "Modifications complete" apply_output.txt || echo "0")
          DESTROYED_COUNT=$(grep -c "Destruction complete" apply_output.txt || echo "0")

          # 出力を制限（20,000文字まで）
          APPLY_OUTPUT=$(cat apply_output.txt)
          if [ ${#APPLY_OUTPUT} -gt 20000 ]; then
            APPLY_OUTPUT="${APPLY_OUTPUT:0:20000}... (output truncated, see workflow logs for full details)"
          fi

          echo "apply-status=$APPLY_STATUS" >> $GITHUB_OUTPUT
          echo "added-count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "changed-count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "destroyed-count=$DESTROYED_COUNT" >> $GITHUB_OUTPUT
          echo "apply-output<<EOF" >> $GITHUB_OUTPUT
          echo "$APPLY_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          exit $APPLY_EXIT_CODE
        continue-on-error: true
        env:
          TF_INPUT: false
          TERRAGRUNT_IAM_ROLE: ${{ steps.load-config.outputs.apply-iam-role }}
          AWS_DEFAULT_REGION: ${{ steps.load-config.outputs.aws-region }}

      - name: Find existing comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'terragrunt-${{ inputs.action_type }}-${{ inputs.environment }}-${{ inputs.project_name }}'

      - name: Create or update PR comment for Plan
        if: github.event_name == 'pull_request' && inputs.action_type == 'plan'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 📋 Terragrunt Plan Results

            <!-- terragrunt-${{ inputs.action_type }}-${{ inputs.environment }}-${{ inputs.project_name }} -->

            **Project**: ${{ inputs.project_name }}
            **Environment**: `${{ inputs.environment }}`
            **Directory**: `${{ steps.load-config.outputs.working-directory }}`
            **IAM Role (Plan)**: ${{ steps.load-config.outputs.plan-iam-role }}
            **AWS Region**: ${{ steps.load-config.outputs.aws-region }}
            **Status**: ${{ steps.plan.outputs.plan-status }}

            ### 📊 Plan Summary

            | Action    | Count |
            | --------- | ----- |
            | 🟢 Add     | ${{ steps.plan.outputs.add-count }}     |
            | 🟡 Change  | ${{ steps.plan.outputs.change-count }}     |
            | 🔴 Destroy | ${{ steps.plan.outputs.destroy-count }}     |

            <details>
            <summary>📝 Plan Output</summary>

            ```
            ${{ steps.plan.outputs.plan-output }}
            ```

            </details>

            [View full workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

      - name: Create or update PR comment for Apply
        if: github.event_name == 'pull_request' && inputs.action_type == 'apply'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 🚀 Terragrunt Apply Completed

            <!-- terragrunt-${{ inputs.action_type }}-${{ inputs.environment }}-${{ inputs.project_name }} -->

            **Project**: ${{ inputs.project_name }}
            **Environment**: `${{ inputs.environment }}`
            **Status**: ${{ steps.apply.outputs.apply-status }}

            ### 📊 Apply Summary

            | Action      | Count |
            | ----------- | ----- |
            | 🟢 Added     | ${{ steps.apply.outputs.added-count }}     |
            | 🟡 Changed   | ${{ steps.apply.outputs.changed-count }}     |
            | 🔴 Destroyed | ${{ steps.apply.outputs.destroyed-count }}     |

            <details>
            <summary>📝 Apply Output</summary>

            ```
            ${{ steps.apply.outputs.apply-output }}
            ```

            </details>

            [View full workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

      - name: Exit with appropriate code
        run: |
          if [ "${{ inputs.action_type }}" == "plan" ]; then
            if [ "${{ steps.plan.outcome }}" == "failure" ]; then
              exit 1
            fi
          else
            if [ "${{ steps.apply.outcome }}" == "failure" ]; then
              exit 1
            fi
          fi
