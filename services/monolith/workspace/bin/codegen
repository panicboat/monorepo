#!/usr/bin/env ruby
require 'bundler/setup'

puts "üöÄ Running buf generate..."

# Find grpc_ruby_plugin using Bundler
begin
  # We need the actual binary for 'buf'.
  # Heuristic: Check if there's a binary in the same gem structure.

  gem_root = Gem::Specification.find_by_name("grpc-tools").gem_dir
  os_name = `uname -s`.strip
  filter = os_name == "Darwin" ? "macos" : "linux"

  binary_dir = Dir[File.join(gem_root, "bin", "*")].find do |d|
    File.directory?(d) && d.include?(filter)
  end

  if binary_dir
    puts "üîç Found grpc plugin in: #{binary_dir}"
    ENV['PATH'] = "#{binary_dir}:#{ENV['PATH']}"
  else
    puts "‚ö†Ô∏è  Could not find native binary for grpc_ruby_plugin. Falling back to default PATH."
  end

rescue Gem::GemNotFoundException
  puts "‚ö†Ô∏è  grpc-tools gem not found. Ensure bundle install is run."
end

# Run buf generate, pointing to the proto definitions at root
# Command runs from current dir (workspace), using local buf.gen.yaml
# Input: ../../../proto (relative to workspace)
system("buf generate ../../../proto")

if $?.success?
  puts "‚úÖ Done."
else
  puts "‚ùå Failed."
  exit 1
end
