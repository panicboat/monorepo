#!/usr/bin/env ruby

# Crucial Fix: Exclude development gems (like hanami-reloader) from loading.
# This prevents the Reloader middleware from being added, fixing Zeitwerk errors.
ENV["BUNDLE_WITHOUT"] = "development:cli:test"
ENV["HANAMI_ENV"] = "production"
ENV["SECRET_KEY_BASE"] ||= "development_secret_key_base_for_local_production_mode"

# Sync output for Docker/Process logging
STDOUT.sync = true
STDERR.sync = true

require "bundler/setup"
require "hanami/setup"

# Boot the app
Hanami.app.boot

# SLEDGEHAMMER FIX: Monkey-patch Zeitwerk::Loader to ignore reload calls
require "zeitwerk"
class Zeitwerk::Loader
  def reload
    puts "DEBUG: Zeitwerk::Loader#reload called (suppressed for gRPC)"
    true
  end
end

require "gruf"
require_relative "../lib/current"
require_relative "../lib/types"
require_relative "../lib/interceptors/access_log_interceptor"
require_relative "../lib/interceptors/authentication_interceptor"

# Ensure Proto files are loaded (they are in lib/)
$LOAD_PATH.unshift(File.expand_path("../stubs", __dir__))
$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))
require "identity/v1/service_services_pb"
require "offer/v1/service_services_pb"
require "portfolio/v1/cast_service_services_pb"
require "portfolio/v1/guest_service_services_pb"
require "social/v1/post_service_services_pb"
require "social/v1/like_service_services_pb"
require "social/v1/follow_service_services_pb"
require "social/v1/comment_service_services_pb"
require "social/v1/block_service_services_pb"
require "social/v1/favorite_service_services_pb"
require "media/v1/media_service_services_pb"
require "relationship/v1/follow_service_services_pb"
require "relationship/v1/block_service_services_pb"
require "relationship/v1/favorite_service_services_pb"

# Configure Gruf
Gruf.configure do |c|
  # Use Hanami logger
  c.logger = Hanami.logger

  # Bind to 0.0.0.0 to ensure Docker/External access if needed, but client tests via localhost
  c.server_binding_url = ENV.fetch("GRPC_BIND_ADDRESS", "0.0.0.0:9001")
  c.interceptors.use(Interceptors::AccessLogInterceptor)
  c.interceptors.use(Interceptors::AuthenticationInterceptor)
  # c.services.clear
end

# Ensure Handlers are loaded so `bind` logic executes!
require_relative "../slices/identity/grpc/handler"
require_relative "../slices/offer/grpc/handler"
require_relative "../slices/offer/grpc/offer_handler"
require_relative "../slices/portfolio/grpc/handler"
require_relative "../slices/portfolio/grpc/cast_handler"
require_relative "../slices/portfolio/grpc/guest_handler"
require_relative "../slices/social/grpc/handler"
require_relative "../slices/social/grpc/post_handler"
require_relative "../slices/social/grpc/like_handler"
require_relative "../slices/social/grpc/follow_handler"
require_relative "../slices/social/grpc/comment_handler"
require_relative "../slices/social/grpc/block_handler"
require_relative "../slices/social/grpc/favorite_handler"
require_relative "../slices/media/grpc/handler"
require_relative "../slices/relationship/grpc/handler"
require_relative "../slices/relationship/grpc/follow_handler"
require_relative "../slices/relationship/grpc/block_handler"
require_relative "../slices/relationship/grpc/favorite_handler"

Hanami.logger.info("Starting gRPC Stub Server on #{Gruf.server_binding_url}")
Hanami.logger.info("Services: #{Gruf.services}")

Gruf::Cli::Executor.new.run
