# post-comments Specification

## Purpose

投稿へのコメント機能を提供する。ゲストとキャストの両方がキャストの投稿にコメントを追加・削除し、コメント一覧を閲覧できるようにする。メディア添付および1階層の返信をサポートする。

## ADDED Requirements

### Requirement: Post Comment Feature

認証済みユーザー（ゲストまたはキャスト）は投稿にコメントを追加できなければならない (MUST)。1つの投稿に対して複数のコメントを投稿できる。

#### Scenario: ゲストが投稿にコメントを追加する

- **GIVEN** 私はログイン済みのゲストである
- **AND** 私は投稿詳細ページを表示している
- **WHEN** 私がコメント入力欄にテキストを入力して送信する
- **THEN** コメントがバックエンドに保存される
- **AND** コメント一覧に新しいコメントが表示される
- **AND** 投稿のコメント数が +1 される

#### Scenario: キャストが投稿にコメントを追加する

- **GIVEN** 私はログイン済みのキャストである
- **AND** 私は投稿詳細ページを表示している
- **WHEN** 私がコメント入力欄にテキストを入力して送信する
- **THEN** コメントがバックエンドに保存される
- **AND** コメント一覧に新しいコメントが表示される
- **AND** コメントには「Cast」バッジが表示される
- **AND** 投稿のコメント数が +1 される

#### Scenario: キャストが自分の投稿にコメントを追加する

- **GIVEN** 私はログイン済みのキャストである
- **AND** 私は自分の投稿の詳細ページを表示している
- **WHEN** 私がコメント入力欄にテキストを入力して送信する
- **THEN** コメントがバックエンドに保存される
- **AND** コメント一覧に新しいコメントが表示される

#### Scenario: コメントの文字数制限

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私はコメント入力欄にテキストを入力している
- **WHEN** 入力が 1000 文字を超える
- **THEN** 入力が制限される
- **AND** 残り文字数が表示される

#### Scenario: 空のコメントは投稿できない

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私はコメント入力欄が空の状態である
- **WHEN** 私が送信ボタンを押す
- **THEN** コメントは投稿されない
- **AND** エラーメッセージが表示される

### Requirement: Comment Media Attachment

ユーザーはコメントに画像や動画を添付できなければならない (MUST)。1コメントあたり最大3枚のメディアを添付できる。

#### Scenario: コメントに画像を添付する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私はコメント入力フォームを表示している
- **WHEN** 私がメディア添付ボタンをタップし、画像を選択する
- **THEN** 選択した画像のプレビューが表示される
- **WHEN** 私がコメントを送信する
- **THEN** 画像付きのコメントがバックエンドに保存される
- **AND** コメント一覧に画像付きコメントが表示される

#### Scenario: コメントに動画を添付する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私はコメント入力フォームを表示している
- **WHEN** 私がメディア添付ボタンをタップし、動画を選択する
- **THEN** 選択した動画のプレビューが表示される
- **WHEN** 私がコメントを送信する
- **THEN** 動画付きのコメントがバックエンドに保存される

#### Scenario: 複数メディアを添付する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私はコメント入力フォームで1枚の画像を添付している
- **WHEN** 私がさらに2枚のメディアを追加する
- **THEN** 合計3枚のプレビューが表示される
- **AND** コメント送信後、3枚のメディア付きコメントが保存される

#### Scenario: メディア上限の制御

- **GIVEN** 私はコメント入力フォームで3枚のメディアを添付している
- **WHEN** 私がさらにメディアを追加しようとする
- **THEN** 追加が拒否される
- **AND** 上限に達していることが表示される

#### Scenario: 添付メディアを削除する

- **GIVEN** 私はコメント入力フォームでメディアを添付している
- **WHEN** 私がプレビューの削除ボタンをタップする
- **THEN** そのメディアが添付リストから削除される

### Requirement: Comment List Display

ユーザーは投稿のコメント一覧を閲覧できなければならない (MUST)。コメントは作成日時の降順（新しい順）で表示される。

#### Scenario: コメント一覧を表示する

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** その投稿にはコメントがある
- **WHEN** ページが読み込まれる
- **THEN** トップレベルのコメント一覧が新しい順に表示される
- **AND** 各コメントには投稿者名、アバター、内容、投稿時刻が表示される
- **AND** メディア付きコメントはメディアも表示される

#### Scenario: ユーザータイプの表示

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** その投稿にはキャストからのコメントがある
- **WHEN** ページが読み込まれる
- **THEN** キャストのコメントには「Cast」バッジが表示される
- **AND** ゲストのコメントにはバッジが表示されない

#### Scenario: コメントがない投稿

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** その投稿にはコメントがない
- **WHEN** ページが読み込まれる
- **THEN** 「まだコメントがありません」のようなメッセージが表示される

#### Scenario: コメント一覧のページネーション

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** その投稿には 20 件以上のコメントがある
- **WHEN** 私が画面下部までスクロールする
- **THEN** 追加のコメントが自動的に読み込まれる

### Requirement: Comment Reply Feature

ユーザーはコメントに返信できなければならない (MUST)。返信は1階層のみサポートされ、返信への返信は不可。

#### Scenario: ゲストがコメントに返信する

- **GIVEN** 私はログイン済みのゲストである
- **AND** 私はトップレベルのコメントを見ている
- **WHEN** 私が「返信」ボタンをタップする
- **THEN** 返信入力フォームが表示される
- **WHEN** 私がテキストを入力して送信する
- **THEN** 返信がバックエンドに保存される
- **AND** 元のコメントの返信数が +1 される
- **AND** 投稿全体のコメント数も +1 される

#### Scenario: キャストがコメントに返信する

- **GIVEN** 私はログイン済みのキャストである
- **AND** 私はトップレベルのコメントを見ている
- **WHEN** 私が「返信」ボタンをタップする
- **THEN** 返信入力フォームが表示される
- **WHEN** 私がテキストを入力して送信する
- **THEN** 返信がバックエンドに保存される
- **AND** 返信には「Cast」バッジが表示される

#### Scenario: 返信一覧を表示する

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** 返信のあるコメントがある
- **WHEN** 私が「返信を見る (N件)」ボタンをタップする
- **THEN** そのコメントの返信一覧が展開表示される

#### Scenario: 返信一覧を折りたたむ

- **GIVEN** 私は返信一覧を展開表示している
- **WHEN** 私が「返信を閉じる」ボタンをタップする
- **THEN** 返信一覧が折りたたまれる

#### Scenario: 返信への返信は不可

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私は返信コメントを見ている
- **THEN** 「返信」ボタンは表示されない

#### Scenario: 返信にメディアを添付する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私は返信入力フォームを表示している
- **WHEN** 私がメディアを添付して返信を送信する
- **THEN** メディア付きの返信がバックエンドに保存される

### Requirement: Comment Delete Feature

ユーザーは自分が投稿したコメントを削除できなければならない (MUST)。他のユーザーのコメントは削除できない。

#### Scenario: ゲストが自分のコメントを削除する

- **GIVEN** 私はログイン済みのゲストである
- **AND** 私が投稿したコメントがある
- **WHEN** 私がそのコメントの削除ボタンをタップする
- **THEN** 確認ダイアログが表示される
- **WHEN** 私が削除を確認する
- **THEN** コメントがバックエンドから削除される
- **AND** コメント一覧から消える
- **AND** 投稿のコメント数が -1 される

#### Scenario: キャストが自分のコメントを削除する

- **GIVEN** 私はログイン済みのキャストである
- **AND** 私が投稿したコメントがある
- **WHEN** 私がそのコメントの削除ボタンをタップする
- **THEN** 確認ダイアログが表示される
- **WHEN** 私が削除を確認する
- **THEN** コメントがバックエンドから削除される
- **AND** コメント一覧から消える

#### Scenario: 返信のあるコメントを削除する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私が投稿したコメントに返信がある
- **WHEN** 私がそのコメントを削除する
- **THEN** コメントとその全ての返信が削除される
- **AND** 投稿のコメント数が適切に更新される

#### Scenario: 自分の返信を削除する

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 私が投稿した返信がある
- **WHEN** 私がその返信を削除する
- **THEN** 返信がバックエンドから削除される
- **AND** 親コメントの返信数が -1 される
- **AND** 投稿のコメント数も -1 される

#### Scenario: 他のユーザーのコメントは削除できない

- **GIVEN** 私はログイン済みのユーザーである
- **AND** 他のユーザーが投稿したコメントがある
- **WHEN** そのコメントを表示する
- **THEN** 削除ボタンは表示されない

### Requirement: Comment API

コメント機能は API を通じて操作できなければならない (MUST)。ゲストとキャスト共通の API エンドポイントを使用する。

#### Scenario: コメントの追加

- **GIVEN** 認証済みのユーザー（ゲストまたはキャスト）
- **WHEN** POST `/api/comments` を post_id, content, media（optional）を指定して呼び出す
- **THEN** コメントが保存され、作成されたコメントと最新の comments_count が返される
- **AND** コメントには投稿者の user_type（"guest" or "cast"）が含まれる

#### Scenario: 返信の追加

- **GIVEN** 認証済みのユーザー（ゲストまたはキャスト）
- **WHEN** POST `/api/comments` を post_id, content, parent_id を指定して呼び出す
- **THEN** 返信が保存され、作成されたコメントと最新の comments_count が返される

#### Scenario: 返信への返信は拒否される

- **GIVEN** 認証済みのユーザー
- **AND** 既に返信であるコメントがある（parent_id が設定されている）
- **WHEN** POST `/api/comments` をその返信の ID を parent_id として呼び出す
- **THEN** 400 Bad Request が返される

#### Scenario: コメントの削除

- **GIVEN** 認証済みのユーザー
- **AND** 自分が投稿したコメントがある
- **WHEN** DELETE `/api/comments/{commentId}` を呼び出す
- **THEN** コメントが削除され、最新の comments_count が返される

#### Scenario: 他人のコメント削除は拒否される

- **GIVEN** 認証済みのユーザー
- **AND** 他のユーザーが投稿したコメントがある
- **WHEN** DELETE `/api/comments/{commentId}` を呼び出す
- **THEN** 403 Forbidden が返される

#### Scenario: コメント一覧の取得

- **GIVEN** 認証済みまたは未認証のユーザー
- **WHEN** GET `/api/comments?post_id={postId}&limit=20` を呼び出す
- **THEN** 指定した投稿のトップレベルコメント一覧が返される
- **AND** `next_cursor` と `has_more` が返される
- **AND** 各コメントには `replies_count` と `author.user_type` が含まれる

#### Scenario: 返信一覧の取得

- **GIVEN** 認証済みまたは未認証のユーザー
- **WHEN** GET `/api/comments/{commentId}/replies?limit=20` を呼び出す
- **THEN** 指定したコメントの返信一覧が返される
- **AND** `next_cursor` と `has_more` が返される

## MODIFIED Requirements

### Requirement: Post Detail Page (from timeline)

投稿詳細ページにコメントセクションを追加しなければならない (MUST)。

#### Scenario: 投稿詳細ページでコメントを表示する

- **GIVEN** 私は投稿詳細ページを表示している
- **WHEN** ページが読み込まれる
- **THEN** 投稿のテキスト、メディア、ハッシュタグの下にコメントセクションが表示される
- **AND** トップレベルコメント一覧が表示される
- **AND** コメント入力フォームが表示される

#### Scenario: コメントセクションで返信を表示する

- **GIVEN** 私は投稿詳細ページを表示している
- **AND** 返信のあるコメントがある
- **WHEN** 私が「返信を見る」をタップする
- **THEN** そのコメントの下に返信一覧が展開される

## Related Capabilities

- `timeline` - タイムライン投稿機能（コメントの対象）
