# Terragrunt CI/CD GitHub Actions ワークフロー - 開発状況まとめ

## 背景・目的
https://github.com/panicboat/monorepo において、Terragruntを使用したインフラストラクチャ管理のCI/CDパイプラインを構築中。PR作成時にPlan、Merge時にApplyを自動実行し、複数のサービスと環境に対応した汎用的なワークフローを実現する。

## 現在の課題
**メイン課題**: PRコメントにTerragruntの詳細な実行結果（init、provider installation、plan details等）が表示されない

**具体的に欲しい出力例**:
```
Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.
Initializing provider plugins...
- Finding hashicorp/aws versions matching "~> 5.0"...
- Installing hashicorp/aws v5.99.1...
Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  ~ update in-place
Terraform will perform the following actions:
  # aws_cloudwatch_log_group.github_actions_logs will be updated in-place
  ~ resource "aws_cloudwatch_log_group" "github_actions_logs" {
      ~ tags = {
          ~ "CostCenter" = "develop" -> "develop1"
        }
    }
Plan: 0 to add, 3 to change, 0 to destroy.
```

## 実装済み機能

### 1. 3段階ワークフロー構成
```
1. サービス固有ワークフロー (example-service-ci-cd.yaml)
   ↓ 呼び出し
2. 環境検出・分散ワークフロー (reusable-terragrunt-orchestrator.yaml)
   ↓ 各環境ごとに並列呼び出し
3. 単環境実行ワークフロー (reusable-terragrunt-single-env.yaml)
```

### 2. 環境検出機能
- 変更されたファイルから影響のあるterragrunt環境を自動検出
- `github-oidc-auth/terragrunt/envs/develop/env.hcl` → `develop`環境として検出
- 複数環境変更時の並列実行

### 3. 認証・権限管理
- **OIDC認証**: `aws-actions/configure-aws-credentials@v4`使用
- **Plan/Apply権限分離**: 各操作に適切なIAMロールを使用
- **設定ファイル**: `.github/terragrunt-actions-config.yaml`で環境別設定

### 4. PRコメント機能
- Plan/Apply結果のPRコメント自動作成・更新
- 環境ごとに独立したコメント管理
- `peter-evans/create-or-update-comment@v4`使用

## 技術的解決済み事項

### 環境検出の修正
**問題**: 正規表現が複雑で`github-oidc-auth/terragrunt/envs/develop/env.hcl`を検出できない
**解決**: シンプルな文字列マッチングに変更
```bash
if [[ "$file" == *"${{ inputs.project_name }}/terragrunt/envs/"* ]]; then
  env_name=$(echo "$env_path" | cut -d'/' -f1)
```

### GitHub Actions出力エラーの修正
**問題**: `Error: Invalid format '0'`
**解決**: JSON出力にcompactオプション追加 `jq -R -s -c`

### 権限エラーの修正
**問題**: reusable workflowでの権限不足
**解決**: 呼び出し元で権限を明示的に設定
```yaml
permissions:
  id-token: write
  contents: read
  pull-requests: write
```

### OIDC認証の修正
**問題**: `TERRAGRUNT_IAM_ROLE`環境変数による重複AssumeRole
**解決**: 環境変数を削除（OIDC認証で既に適切なロールを使用中）

## 現在使用中のアクション

### `gruntwork-io/terragrunt-action@v2`
**出力**:
- `tg_action_output`: Terragrunt実行出力
- `tg_action_exit_code`: 終了コード

**既知の問題**:
- 出力フォーマットの問題（Issue #21で報告済み）
- 出力キャプチャの失敗（Issue #11で報告済み）

## 現在のワークフロー構成

### 設定ファイル例
```yaml
# .github/terragrunt-actions-config.yaml
default:
  iam_role_plan: arn:aws:iam::559744160976:role/github-oidc-auth-develop-github-actions-role
  iam_role_apply: arn:aws:iam::559744160976:role/github-oidc-auth-develop-github-actions-role
  aws_region: ap-northeast-1

develop:
  iam_role_plan: arn:aws:iam::559744160976:role/github-oidc-auth-develop-github-actions-role
  iam_role_apply: arn:aws:iam::559744160976:role/github-oidc-auth-develop-github-actions-role
  aws_region: ap-northeast-1
```

### 実装済みフォールバック機能
`tg_action_output`が空の場合、独自にterragruntを実行して出力を取得する仕組みを実装中。

## 次のステップ
1. **詳細出力の取得確認**: 現在のデバッグログで`tg_action_output`の内容を確認
2. **フォールバック機能の調整**: 必要に応じてさらなる改善
3. **変更数抽出の精度向上**: "Plan: X to add, Y to change, Z to destroy"パターンの解析改善

## 最新のartifact
現在の完全なワークフロー定義は`terragrunt_workflow_structure`というartifactに保存されており、3つのワークフローファイルと設定ファイルの完全な定義が含まれている。
